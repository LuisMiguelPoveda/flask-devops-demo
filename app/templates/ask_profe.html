{% extends "base.html" %}

{% block title %}Pregúntale al profe{% endblock %}

{% block content %}
  <div class="card">
    <div class="profe-timer" id="profe-timer" data-ends-at="{{ lock_ends_at_ts }}">
      <span class="profe-timer__label">Tiempo reservado de tutoría restante:</span>
      <span class="profe-timer__value" id="profe-timer-value">{{ lock_remaining_label }}</span>
    </div>
    <h2>Pregúntale al profe</h2>
    <p>Escribe tu duda, elige un modelo y pulsa Enviar.</p>

    <form method="post" id="ask-form">
      <div>
        <label for="model">Modelo</label>
        <select id="model" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>
              {{ model }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="question">Tu pregunta</label>
        <textarea id="question" name="question" rows="5" required></textarea>
      </div>

      <!-- Opciones navegables por flechas + enter -->
      <ul class="nav-list" data-nav>
        <li>
          <button class="nav-option" type="submit" id="submit-btn">Enviar</button>
        </li>
        <li>
          <a class="nav-option" href="{{ url_for('dashboard') }}">Volver al menú</a>
        </li>
      </ul>
    </form>

    <div id="loading-indicator" style="display:none; margin-top: 12px;">
      <em>El profe está pensando... ⏳</em>
    </div>

    {% if messages %}
      <div class="chat">
        {% for msg in messages|reverse %}
          <div class="chat-message {{ msg.role }}">
            <strong>{% if msg.role == 'user' %}Tú{% else %}Profe{% endif %}:</strong>
            {% if msg.role == 'assistant' %}
              <div class="chat-message__content">{{ msg.content | note_fmt }}</div>
            {% else %}
              <p>{{ msg.content }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    const form = document.getElementById("ask-form");
    const loading = document.getElementById("loading-indicator");
    const submitBtn = document.getElementById("submit-btn");
    const question = document.getElementById("question");
    const timer = document.getElementById("profe-timer");
    const timerValue = document.getElementById("profe-timer-value");
    const lockEndsAt = timer ? Number(timer.dataset.endsAt || "0") : 0;

    if (form && loading && submitBtn) {
      form.addEventListener("submit", function () {
        loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
      });
    }

    if (question && form) {
      question.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });
    }

    function formatRemaining(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    function updateTimer() {
      if (!lockEndsAt || !timerValue) return;
      const remainingSeconds = Math.max(0, Math.ceil((lockEndsAt - Date.now()) / 1000));
      timerValue.textContent = formatRemaining(remainingSeconds);
      if (remainingSeconds <= 0) {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Tiempo agotado";
        }
        window.location.href = "{{ url_for('dashboard') }}";
      }
    }

    if (lockEndsAt) {
      updateTimer();
      setInterval(updateTimer, 1000);
    }
  </script>
{% endblock %}
