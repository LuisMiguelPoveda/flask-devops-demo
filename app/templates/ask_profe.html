{% extends "base.html" %}

{% block title %}Pregúntale al profe{% endblock %}

{% block content %}
  <div class="card">
    <h2>Pregúntale al profe</h2>
    <p>Escribe tu duda, elige un modelo y pulsa Enviar.</p>

    <form method="post" id="ask-form">
      <div>
        <label for="model">Modelo</label>
        <select id="model" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>
              {{ model }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="question">Tu pregunta</label>
        <textarea id="question" name="question" rows="5" required></textarea>
      </div>

      <!-- Opciones navegables por flechas + enter -->
      <ul class="nav-list" data-nav>
        <li>
          <button class="nav-option" type="submit" id="submit-btn">Enviar</button>
        </li>
        <li>
          <a class="nav-option" href="{{ url_for('dashboard') }}">Volver al menú</a>
        </li>
      </ul>
    </form>

    <div id="loading-indicator" style="display:none; margin-top: 12px;">
      <em>El profe está pensando... ⏳</em>
    </div>

    {% if messages %}
      <div class="chat">
        {% for msg in messages|reverse %}
          <div class="chat-message {{ msg.role }}">
            <strong>{% if msg.role == 'user' %}Tú{% else %}Profe{% endif %}:</strong>
            {% if msg.role == 'assistant' %}
              <div class="chat-message__content">{{ msg.content | note_fmt }}</div>
            {% else %}
              <p>{{ msg.content }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    const form = document.getElementById("ask-form");
    const loading = document.getElementById("loading-indicator");
    const submitBtn = document.getElementById("submit-btn");
    const question = document.getElementById("question");

    if (form && loading && submitBtn) {
      form.addEventListener("submit", function () {
        loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
      });
    }

    if (question && form) {
      question.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });
    }
  </script>
{% endblock %}
