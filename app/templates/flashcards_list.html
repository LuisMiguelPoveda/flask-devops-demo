{% extends "base.html" %}
{% block title %}Flashcards{% endblock %}

{% block content %}
  <section class="shell">
    <header class="section-header">
      <div>
        <h1 class="headline">Flashcards</h1>
        <p class="subtle">Filtra, edita o borra tus decks.</p>
      </div>
    </header>

    <style>
      .flashcard-option {
        display: block;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
        transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
        cursor: pointer;
      }

      .flashcard-option:hover,
      .flashcard-option:focus-visible {
        outline: none;
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
        border-color: rgba(59, 130, 246, 0.6);
        background: rgba(59, 130, 246, 0.08);
      }

      .flashcard-option.is-correct {
        color: #16a34a;
        font-weight: 700;
        border-color: rgba(22, 163, 74, 0.6);
        background: rgba(22, 163, 74, 0.12);
      }

      .flashcard-option.is-wrong {
        color: #dc2626;
        font-weight: 700;
        border-color: rgba(220, 38, 38, 0.6);
        background: rgba(220, 38, 38, 0.12);
      }
    </style>

    <div class="card" style="margin-bottom:14px;">
      <div class="check-row" style="margin-bottom:12px;">
        <input type="checkbox" id="flashcards-answer-toggle" />
        <label for="flashcards-answer-toggle" style="margin:0;">
          Mostrar respuestas correctas e incorrectas
        </label>
      </div>
      <details {% if filters_active %}open{% endif %}>
        <summary>Filtros</summary>
        <form method="get" class="filters" style="margin-top: 1rem;">
          <div>
            <label for="subject_id">Asignatura</label>
            <select id="subject_id" name="subject_id">
              <option value="">(todas)</option>
              {% for s in subjects %}
                <option value="{{ s.id }}" {% if filters.subject_id|string == s.id|string %}selected{% endif %}>{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="tema">Tema</label>
            <select id="tema" name="tema">
              <option value="">(todos)</option>
              {% for t in temas %}
                <option value="{{ t }}" {% if filters.tema == t %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="title">Título contiene</label>
            <input id="title" name="title" value="{{ filters.title }}" placeholder="Ej: fotosíntesis" />
          </div>

          <ul class="nav-list" data-nav>
            <li><button class="nav-option btn-primary" type="submit">Filtrar</button></li>
            <li><a class="nav-option" href="{{ url_for('flashcards_list') }}">Limpiar</a></li>
            <li><a class="nav-option" href="{{ url_for('flashcards_create') }}">Crear flashcards</a></li>
          </ul>
        </form>
      </details>
    </div>

    {% if decks|length == 0 %}
      <div class="card"><p>No hay decks con esos filtros.</p></div>
    {% else %}
      {% for d in decks %}
        <div class="card" style="margin-bottom:14px;">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
            <div>
              <h3 style="margin:0;">{{ d.title }}</h3>
              <p style="margin:4px 0 0 0;">
                <strong>Asignatura:</strong> {{ d.subject.name }} |
                <strong>Fecha de examen:</strong> {{ d.exam_date if d.exam_date else "—" }} |
                {% set tema_list = deck_temas.get(d.id) %}
                <strong>Tema:</strong> {{ tema_list|join(", ") if tema_list else "—" }} |
                <strong>Flashcards:</strong> {{ d.flashcards|length }}
              </p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <a class="link-pill" href="{{ url_for('flashcards_edit', deck_id=d.id) }}">Editar</a>
              <form method="post" action="{{ url_for('flashcards_delete', deck_id=d.id) }}">
                <button type="submit" onclick="return confirm('¿Borrar este deck?');">Borrar</button>
              </form>
            </div>
          </div>

          <details style="margin-top:10px;">
            <summary>Ver flashcards</summary>
            <div style="display:grid;gap:10px;margin-top:10px;">
              {% for card in d.flashcards %}
                <div class="card" data-flashcard-card style="padding:10px;background:rgba(0,0,0,0.06);">
                  <strong>Q{{ loop.index }}.</strong> {{ card.question }}
                  <ol style="margin:8px 0 0 16px;padding:0;">
                    {% for opt in card.options %}
                      <li
                        class="flashcard-option"
                        data-correct="{{ '1' if loop.index0 == card.correct_index else '0' }}"
                        role="button"
                        tabindex="0"
                      >
                        {{ opt }}
                      </li>
                    {% endfor %}
                  </ol>
                </div>
              {% endfor %}
            </div>
          </details>
        </div>
      {% endfor %}
    {% endif %}
  </section>

  <script>
    (function () {
      const toggle = document.getElementById("flashcards-answer-toggle");
      const optionSelector = ".flashcard-option";
      if (!toggle) return;

      function shuffleArray(items) {
        for (let i = items.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [items[i], items[j]] = [items[j], items[i]];
        }
        return items;
      }

      const cards = Array.from(document.querySelectorAll("[data-flashcard-card]"));
      cards.forEach((card) => {
        const list = card.querySelector("ol");
        if (!list) return;
        const items = Array.from(list.querySelectorAll(optionSelector));
        if (items.length < 2) return;
        const shuffled = shuffleArray(items.slice());
        shuffled.forEach((item) => list.appendChild(item));
      });

      const options = Array.from(document.querySelectorAll(optionSelector));

      function clearAllHighlights() {
        options.forEach((opt) => opt.classList.remove("is-correct", "is-wrong"));
      }

      function applyGlobalHighlights() {
        options.forEach((opt) => {
          const isCorrect = opt.dataset.correct === "1";
          opt.classList.remove("is-correct", "is-wrong");
          opt.classList.add(isCorrect ? "is-correct" : "is-wrong");
        });
      }

      function updateFromToggle() {
        if (toggle.checked) {
          applyGlobalHighlights();
        } else {
          clearAllHighlights();
        }
      }

      function handleOptionActivate(option) {
        if (toggle.checked) return;
        const card = option.closest("[data-flashcard-card]");
        if (!card) return;
        card.querySelectorAll(optionSelector).forEach((opt) => opt.classList.remove("is-correct", "is-wrong"));
        const isCorrect = option.dataset.correct === "1";
        option.classList.add(isCorrect ? "is-correct" : "is-wrong");
      }

      toggle.addEventListener("change", updateFromToggle);
      updateFromToggle();

      options.forEach((opt) => {
        opt.addEventListener("click", () => handleOptionActivate(opt));
        opt.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            handleOptionActivate(opt);
          }
        });
      });
    })();
  </script>
{% endblock %}
