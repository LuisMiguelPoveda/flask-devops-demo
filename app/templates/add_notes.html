{% extends "base.html" %}

{% block title %}Generar resumen{% endblock %}

{% block content %}
  <div class="card">
    <h2>Generar resumen (solo TXT)</h2>

    <p>
      Para evitar errores del modelo, esta página tiene restricciones:
    </p>
    <ul>
      <li><strong>Solo archivos .txt</strong></li>
      <li><strong>Tamaño máximo: {{ max_kb }} KB</strong></li>
      <li><strong>Se envían al modelo como máximo {{ max_chars }} caracteres</strong> (si el texto es más largo, se recorta)</li>
      <li><strong>No se guarda el archivo</strong>, solo el resumen + asignatura + fecha</li>
    </ul>

    <form method="post" enctype="multipart/form-data" id="notes-form">
      <div>
        <label for="model">Modelo</label>
        <select id="model" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="subject_choice">Asignatura</label>
        <select id="subject_choice" name="subject_choice" required>
          {% for s in subjects %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
          <option value="__new__">+ Añadir nueva asignatura…</option>
        </select>
      </div>

      <div id="new-subject-wrap" style="display:none;">
        <label for="new_subject_name">Nueva asignatura</label>
        <input id="new_subject_name" name="new_subject_name" placeholder="Ej: Matemáticas" />
      </div>

      <div>
        <label for="exam_date_choice">Fecha de evaluación (existente para la asignatura)</label>
        <select id="exam_date_choice" name="exam_date_choice">
          <option value="">(sin seleccionar)</option>
        </select>
      </div>

      <div>
        <label for="exam_date_manual">O introducir fecha manual (YYYY-MM-DD)</label>
        <input id="exam_date_manual" name="exam_date_manual" type="date" />
      </div>

      <div>
        <label for="file">Archivo TXT</label>
        <input id="file" name="file" type="file" accept=".txt,text/plain" required />
      </div>

      <button type="submit" id="submit-btn">Generar y guardar</button>
      <a href="{{ url_for('dashboard') }}" style="margin-left: 1rem;">Volver al menú</a>
    </form>

    <div id="loading-indicator" style="display:none; margin-top: 12px;">
      <em>Generando resumen... ⏳</em>
    </div>
  </div>

  <script>
    const subjectSelect = document.getElementById("subject_choice");
    const newWrap = document.getElementById("new-subject-wrap");
    const newInput = document.getElementById("new_subject_name");

    const examSelect = document.getElementById("exam_date_choice");
    const examManual = document.getElementById("exam_date_manual");

    const form = document.getElementById("notes-form");
    const loading = document.getElementById("loading-indicator");
    const submitBtn = document.getElementById("submit-btn");

    async function loadExamDates(subjectId) {
      examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      if (!subjectId) return;

      const resp = await fetch(`/api/exam-dates?subject_id=${encodeURIComponent(subjectId)}`);
      const data = await resp.json();

      (data.dates || []).forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        examSelect.appendChild(opt);
      });
    }

    function updateSubjectUI() {
      const val = subjectSelect.value;
      const isNew = (val === "__new__");
      newWrap.style.display = isNew ? "block" : "none";
      if (!isNew) newInput.value = "";

      if (isNew) {
        examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      } else {
        loadExamDates(val);
      }
    }

    subjectSelect.addEventListener("change", updateSubjectUI);

    // Si el usuario elige una fecha existente, limpia la manual
    examSelect.addEventListener("change", () => {
      if (examSelect.value) examManual.value = "";
    });

    // Si el usuario pone fecha manual, limpia la del desplegable
    examManual.addEventListener("change", () => {
      if (examManual.value) examSelect.value = "";
    });

    if (form && loading && submitBtn) {
      form.addEventListener("submit", function () {
        loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Procesando...";
      });
    }

    updateSubjectUI();
  </script>
{% endblock %}
