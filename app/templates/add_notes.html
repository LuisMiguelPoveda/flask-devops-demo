{% extends "base.html" %}

{% block title %}Generar resumen{% endblock %}

{% block content %}
  <div class="card">
    <h2>Generar resumen (solo TXT)</h2>

    <p>Restricciones:</p>
    <ul>
      <li><strong>Solo archivos .txt</strong></li>
      <li><strong>Tamaño máximo: {{ max_kb }} KB</strong></li>
      <li><strong>Se envían al modelo como máximo {{ max_chars }} caracteres</strong></li>
      <li><strong>No se guarda el archivo</strong>, solo el resumen + asignatura + tema + fecha</li>
    </ul>

    <form method="post" enctype="multipart/form-data" id="notes-form">
      <div>
        <label for="model">Modelo</label>
        <select id="model" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="subject_choice">Asignatura</label>
        <select id="subject_choice" name="subject_choice" required>
          {% for s in subjects %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
          <option value="__new__">+ Añadir nueva asignatura…</option>
        </select>
      </div>

      <div id="new-subject-wrap" style="display:none;">
        <label for="new_subject_name">Nueva asignatura</label>
        <input id="new_subject_name" name="new_subject_name" placeholder="Ej: Matemáticas" />
      </div>

      <hr />

      <div>
        <label for="topic_choice">Temas del examen</label>
        <select id="topic_choice" name="topic_choice" required>
          <option value="">(cargando…)</option>
        </select>
        <small>Elige un tema existente o crea uno nuevo.</small>
      </div>

      <div id="new-topic-wrap" style="display:none;">
        <label for="new_topic_name">Nuevo tema</label>
        <input id="new_topic_name" name="new_topic_name" placeholder="Ej: Tema 3 - Derivadas" />
      </div>

      <hr />

      <div>
        <label for="exam_date_choice">Fecha de evaluación (existente para la asignatura)</label>
        <select id="exam_date_choice" name="exam_date_choice">
          <option value="">(sin seleccionar)</option>
        </select>
      </div>

      <div>
        <label for="exam_date_manual">O introducir fecha manual</label>
        <input id="exam_date_manual" name="exam_date_manual" type="date" />
      </div>

      <div>
        <label for="file">Archivo TXT</label>
        <input id="file" name="file" type="file" accept=".txt,text/plain" required />
      </div>

      <button type="submit" id="submit-btn">Generar y guardar</button>
      <a href="{{ url_for('dashboard') }}" style="margin-left: 1rem;">Volver al menú</a>
    </form>

    <div id="loading-indicator" style="display:none; margin-top: 12px;">
      <em>Generando resumen... ⏳</em>
    </div>
  </div>

  <script>
    const subjectSelect = document.getElementById("subject_choice");
    const newSubjectWrap = document.getElementById("new-subject-wrap");
    const newSubjectInput = document.getElementById("new_subject_name");

    const topicSelect = document.getElementById("topic_choice");
    const newTopicWrap = document.getElementById("new-topic-wrap");
    const newTopicInput = document.getElementById("new_topic_name");

    const examSelect = document.getElementById("exam_date_choice");
    const examManual = document.getElementById("exam_date_manual");

    const form = document.getElementById("notes-form");
    const loading = document.getElementById("loading-indicator");
    const submitBtn = document.getElementById("submit-btn");

    async function loadExamDates(subjectId) {
      examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      if (!subjectId) return;

      const resp = await fetch(`/api/exam-dates?subject_id=${encodeURIComponent(subjectId)}`);
      const data = await resp.json();
      (data.dates || []).forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        examSelect.appendChild(opt);
      });
    }

    async function loadTopics(subjectId) {
      topicSelect.innerHTML = '';
      newTopicWrap.style.display = "none";
      newTopicInput.value = "";

      if (!subjectId) {
        // Si estamos creando asignatura nueva, no hay temas: forzamos a crear tema
        topicSelect.innerHTML = `
          <option value="__new__" selected>+ Crear nuevo tema…</option>
        `;
        newTopicWrap.style.display = "block";
        return;
      }

      const resp = await fetch(`/api/topics?subject_id=${encodeURIComponent(subjectId)}`);
      const data = await resp.json();
      const topics = data.topics || [];

      if (topics.length === 0) {
        topicSelect.innerHTML = `<option value="__new__" selected>+ Crear nuevo tema…</option>`;
        newTopicWrap.style.display = "block";
        return;
      }

      // temas existentes + opción de crear
      topics.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        topicSelect.appendChild(opt);
      });

      const optNew = document.createElement("option");
      optNew.value = "__new__";
      optNew.textContent = "+ Crear nuevo tema…";
      topicSelect.appendChild(optNew);

      // por defecto: primer tema
      topicSelect.value = topics[0].id;
    }

    function updateSubjectUI() {
      const val = subjectSelect.value;
      const isNew = (val === "__new__");

      newSubjectWrap.style.display = isNew ? "block" : "none";
      if (!isNew) newSubjectInput.value = "";

      if (isNew) {
        examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
        loadTopics(null);
      } else {
        loadExamDates(val);
        loadTopics(val);
      }
    }

    function updateTopicUI() {
      const val = topicSelect.value;
      const isNew = (val === "__new__");
      newTopicWrap.style.display = isNew ? "block" : "none";
      if (!isNew) newTopicInput.value = "";
    }

    subjectSelect.addEventListener("change", updateSubjectUI);
    topicSelect.addEventListener("change", updateTopicUI);

    examSelect.addEventListener("change", () => {
      if (examSelect.value) examManual.value = "";
    });

    examManual.addEventListener("change", () => {
      if (examManual.value) examSelect.value = "";
    });

    if (form && loading && submitBtn) {
      form.addEventListener("submit", function () {
        loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Procesando...";
      });
    }

    // init
    updateSubjectUI();
  </script>
{% endblock %}
