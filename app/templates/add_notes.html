{% extends "base.html" %}

{% block title %}Subir apuntes{% endblock %}

{% block content %}
  <div class="card">
    <h2>Subir apuntes / Generar resumen</h2>

    <p>Opciones:</p>
    <ul>
      <li><strong>IA (TXT):</strong> subes un .txt y se generan apuntes con el modelo.</li>
      <li><strong>Manual:</strong> escribes el contenido y se guarda tal cual (sin IA).</li>
    </ul>

    <p><strong>Restricciones IA:</strong> solo .txt, máximo {{ max_kb }} KB, y se recorta a {{ max_chars }} caracteres.</p>

    <form method="post" enctype="multipart/form-data" id="notes-form">
      <div>
        <label for="model">Modelo (solo si usas IA)</label>
        <select id="model" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="subject_choice">Asignatura</label>
        <select id="subject_choice" name="subject_choice" required>
          {% for s in subjects %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
          <option value="__new__">+ Añadir nueva asignatura…</option>
        </select>
      </div>

      <div id="new-subject-wrap" style="display:none;">
        <label for="new_subject_name">Nueva asignatura</label>
        <input id="new_subject_name" name="new_subject_name" placeholder="Ej: Matemáticas" />
      </div>

      <div>
        <label for="title">Título del apunte</label>
        <input id="title" name="title" placeholder="Ej: Tema 3 - Derivadas" required />
        <small>Este título se usará para identificar y filtrar.</small>
      </div>

      <div>
        <label for="exam_date_choice">Fecha de examen (existente para esa asignatura)</label>
        <select id="exam_date_choice" name="exam_date_choice">
          <option value="">(sin seleccionar)</option>
        </select>
      </div>

      <div>
        <label for="exam_date_manual">O introducir fecha manual</label>
        <input id="exam_date_manual" name="exam_date_manual" type="date" />
      </div>

      <hr />

      <div class="check-row">
        <input type="checkbox" id="manual_mode" name="manual_mode" />
        <label for="manual_mode" style="margin:0;">Guardar manualmente (sin IA)</label>
      </div>

      <div id="manual-wrap" style="display:none;">
        <label for="manual_text">Contenido manual</label>
        <textarea id="manual_text" name="manual_text" rows="10" placeholder="Escribe aquí tus apuntes..."></textarea>
      </div>

      <div id="file-wrap">
        <label for="file">Archivo TXT (solo si usas IA)</label>
        <input id="file" name="file" type="file" accept=".txt,text/plain" />
      </div>

      <button type="submit" id="submit-btn">Guardar</button>
      <a href="{{ url_for('dashboard') }}" style="margin-left: 1rem;">Volver al menú</a>
    </form>

    <div id="loading-indicator" style="display:none; margin-top: 12px;">
      <em>Procesando... ⏳</em>
    </div>
  </div>

  <script>
    const subjectSelect = document.getElementById("subject_choice");
    const newWrap = document.getElementById("new-subject-wrap");
    const newInput = document.getElementById("new_subject_name");

    const examSelect = document.getElementById("exam_date_choice");
    const examManual = document.getElementById("exam_date_manual");

    const manualMode = document.getElementById("manual_mode");
    const manualWrap = document.getElementById("manual-wrap");
    const fileWrap = document.getElementById("file-wrap");

    const form = document.getElementById("notes-form");
    const loading = document.getElementById("loading-indicator");
    const submitBtn = document.getElementById("submit-btn");

    async function loadExamDates(subjectId) {
      examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      if (!subjectId) return;

      const resp = await fetch(`/api/exam-dates?subject_id=${encodeURIComponent(subjectId)}`);
      const data = await resp.json();

      (data.dates || []).forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        examSelect.appendChild(opt);
      });
    }

    function updateSubjectUI() {
      const val = subjectSelect.value;
      const isNew = (val === "__new__");
      newWrap.style.display = isNew ? "block" : "none";
      if (!isNew) newInput.value = "";

      if (isNew) {
        examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      } else {
        loadExamDates(val);
      }
    }

    function updateModeUI() {
      const isManual = manualMode.checked;
      manualWrap.style.display = isManual ? "block" : "none";
      fileWrap.style.display = isManual ? "none" : "block";
    }

    subjectSelect.addEventListener("change", updateSubjectUI);

    examSelect.addEventListener("change", () => {
      if (examSelect.value) examManual.value = "";
    });

    examManual.addEventListener("change", () => {
      if (examManual.value) examSelect.value = "";
    });

    manualMode.addEventListener("change", updateModeUI);

    if (form && loading && submitBtn) {
      form.addEventListener("submit", function () {
        loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Procesando...";
      });
    }

    updateSubjectUI();
    updateModeUI();
  </script>
{% endblock %}
