{% extends "base.html" %}

{% block title %}Añadir apuntes{% endblock %}

{% block content %}
  <div class="card">
    <h2>Añadir apuntes</h2>
    <p>Sube un TXT o PDF. Generaremos apuntes y los guardaremos para tu usuario.</p>

    <form method="post" enctype="multipart/form-data" id="notes-form">
      <div>
        <label for="model">Modelo</label>
        <select id="model" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>
              {{ model }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="subject_choice">Asignatura</label>
        <select id="subject_choice" name="subject_choice" required>
          {% if subjects|length == 0 %}
            <option value="__new__" selected>No tienes asignaturas aún (crear nueva)</option>
          {% endif %}

          {% for s in subjects %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}

          <option value="__new__">+ Añadir nueva asignatura…</option>
        </select>
      </div>

      <div id="new-subject-wrap" style="display:none;">
        <label for="new_subject_name">Nueva asignatura</label>
        <input id="new_subject_name" name="new_subject_name" placeholder="Ej: Matemáticas, Historia..." />
      </div>

      <div>
        <label for="exam_date_choice">Fecha de examen (existente para esa asignatura)</label>
        <select id="exam_date_choice" name="exam_date_choice">
          <option value="">(sin seleccionar)</option>
        </select>
      </div>

      <div>
        <label for="exam_date_manual">
          O introducir fecha manual (formato YYYY-MM-DD)
        </label>
        <input
          id="exam_date_manual"
          name="exam_date_manual"
          type="text"
          inputmode="numeric"
          placeholder="YYYY-MM-DD (ej: 2026-01-15)"
          pattern="\\d{4}-\\d{2}-\\d{2}"
        />
      </div>

      <div>
        <label for="file">Archivo (TXT o PDF)</label>
        <input id="file" name="file" type="file" accept=".txt,.pdf" required />
      </div>

      <ul class="nav-list" data-nav>
        <li>
          <button class="nav-option" type="submit" id="submit-btn">Generar y guardar apuntes</button>
        </li>
        <li>
          <a class="nav-option" href="{{ url_for('dashboard') }}">Volver al menú</a>
        </li>
      </ul>
    </form>

    <div id="loading-indicator" style="display:none; margin-top: 12px;">
      <em>Generando apuntes... ⏳ (puede tardar)</em>
    </div>
  </div>

  <script>
    const subjectSelect = document.getElementById("subject_choice");
    const newWrap = document.getElementById("new-subject-wrap");
    const newInput = document.getElementById("new_subject_name");

    const examSelect = document.getElementById("exam_date_choice");
    const examManual = document.getElementById("exam_date_manual");

    const form = document.getElementById("notes-form");
    const loading = document.getElementById("loading-indicator");
    const submitBtn = document.getElementById("submit-btn");

    async function loadExamDates(subjectId) {
      examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      if (!subjectId) return;

      const resp = await fetch(`/api/exam-dates?subject_id=${encodeURIComponent(subjectId)}`);
      const data = await resp.json();

      (data.dates || []).forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        examSelect.appendChild(opt);
      });
    }

    function updateSubjectUI() {
      const val = subjectSelect.value;
      const isNew = (val === "__new__");
      newWrap.style.display = isNew ? "block" : "none";
      if (!isNew) newInput.value = "";
      if (isNew) {
        // no hay fechas existentes si estás creando
        examSelect.innerHTML = '<option value="">(sin seleccionar)</option>';
      } else {
        loadExamDates(val);
      }
    }

    subjectSelect.addEventListener("change", updateSubjectUI);

    // Si el usuario escribe fecha manual, anulamos la selección del dropdown (opcional)
    examManual.addEventListener("input", () => {
      if (examManual.value.trim()) {
        examSelect.value = "";
      }
    });

    // Y si selecciona una fecha existente, vaciamos manual (opcional)
    examSelect.addEventListener("change", () => {
      if (examSelect.value) {
        examManual.value = "";
      }
    });

    // Loading al enviar
    if (form && loading && submitBtn) {
      form.addEventListener("submit", function () {
        loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Procesando...";
      });
    }

    // Inicializa UI al cargar
    updateSubjectUI();
  </script>
{% endblock %}
