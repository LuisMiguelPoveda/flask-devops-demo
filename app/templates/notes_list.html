{% extends "base.html" %}

{% block title %}Consultar apuntes{% endblock %}

{% block content %}
  <div class="card">
    <h2>Consultar apuntes</h2>

    <details {% if filters_active %}open{% endif %}>
      <summary>Filtros</summary>
      <form method="get" style="margin: 1rem 0;">
        <div>
          <label for="subject_id">Asignatura</label>
          <select id="subject_id" name="subject_id">
            <option value="">(todas)</option>
            {% for s in subjects %}
              <option value="{{ s.id }}" {% if filters.subject_id|string == s.id|string %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="tema">Tema</label>
          <select id="tema" name="tema">
            <option value="">(todos)</option>
            {% for t in temas %}
              <option value="{{ t }}" {% if filters.tema == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="title">Título contiene</label>
          <input id="title" name="title" type="text" value="{{ filters.title }}" placeholder="Ej: Derivadas" />
        </div>

        <button type="submit">Filtrar</button>
        <a href="{{ url_for('notes_list') }}" style="margin-left: 1rem;">Limpiar</a>
        <a href="{{ url_for('dashboard') }}" style="margin-left: 1rem;">Volver al menú</a>
      </form>
    </details>

    {% if notes|length == 0 %}
      <p>No hay apuntes con esos filtros.</p>
    {% else %}
      {% for n in notes %}
        <div class="card" style="margin-top: 1rem;">
          <h3>{{ n.title }}</h3>
          <p>
            <strong>Asignatura:</strong> {{ n.subject.name }} |
            <strong>Fecha de examen:</strong> {{ n.exam_date if n.exam_date else "—" }} |
            {% set tema_list = note_temas.get(n.id) %}
            <strong>Tema:</strong> {{ tema_list|join(", ") if tema_list else "—" }} |
            <strong>Modelo:</strong>
            {% if n.ai_used %}
              {{ note_models.get(n.id, "—") }}
            {% else %}
              Manual
            {% endif %}
            {% if n.ai_used and chunk_totals.get(n.id) %}
              | <strong>Fragmentos IA:</strong> {{ chunk_totals.get(n.id) }}
            {% endif %} |
            <strong>Creado:</strong> {{ n.created_at.strftime("%Y-%m-%d") if n.created_at else "—" }}
          </p>

          {% set source_file = source_files.get(n.id) %}
          <div class="details-row">
            <details>
              <summary class="details-toggle">Ver contenido</summary>
              <div style="margin-top:8px;">{{ n.content|note_fmt }}</div>
              <div class="details-actions">
                <a class="action-link" href="{{ url_for('note_edit', note_id=n.id) }}">Editar</a>
              </div>
              {% if n.ai_used and source_file %}
                <div class="details-actions">
                  <a
                    href="{{ url_for('note_source_file', note_id=n.id) }}"
                    class="action-link"
                  >Descargar archivo original: {{ source_file.filename }}</a>
                </div>
              {% endif %}
            </details>

            <form method="post" action="{{ url_for('note_delete', note_id=n.id) }}" class="details-row__action">
              <button type="submit" class="action-link action-link--danger" onclick="return confirm('¿Seguro que quieres borrar este apunte?');">
                Borrar
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% endif %}

    {% if notes|length > 1 %}
      <div class="card" style="margin-top:1rem;">
        <h3>Combinar apuntes</h3>
        <form method="post" action="{{ url_for('notes_merge') }}">
          <div>
            <label for="target_note">Destino</label>
            <select id="target_note" name="target_note" required>
              <option value="">(elige destino)</option>
              {% for n in notes %}
                <option value="{{ n.id }}">{{ n.title }} — {{ n.subject.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="source_note">Origen (se copiará su contenido)</label>
            <select id="source_note" name="source_note" required>
              <option value="">(elige origen)</option>
              {% for n in notes %}
                <option value="{{ n.id }}">{{ n.title }} — {{ n.subject.name }}</option>
              {% endfor %}
            </select>
          </div>
          <p class="subtle">Se añadirá el contenido del origen al final del destino. Ambos apuntes permanecerán.</p>
          <button type="submit">Combinar</button>
        </form>
      </div>
    {% endif %}
  </div>
{% endblock %}
